Запуск сервиса AddressOK
===============================================================================

Сервис AddressOK представляет собой несколько Docker-контейнеров. Для запуска
сервиса необходимо установить
`Docker <https://docs.docker.com/engine/installation/linux/ubuntulinux/>`_
и `Docker Compose <https://docs.docker.com/compose/install/>`_.

Запуск Docker-контейнеров
-------------------------------------------------------------------------------

Для запуска сервиса необходимо:

* Запустить data-контейнер
* Запустить все остальные контейнеры с помощью Docker Compose

Запуск data-контейнера
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Data-контейнер --- это специальный контейнер, предназначенный для хранения
данных. Все остальные контейнеры используют его для хранения своих данных.
Таким образом, в случае необходимости пересоздания остальных
контейнеров данные не будут потеряны.

Если вы запускаете сервис в первый раз, то data-контейнер ещё не создан.
Для его создания предназначен bash-скрипт ``make_dvc``, который необходимо выполнить
в консоли, находясь в папке ``addressok_docker_compose``.

.. code-block:: bash
    
    cd addressok_docker_compose
    ./make_dvc

Data-контейнер
будет иметь имя ``addressokdata``.

В дальнейшем, когда data-контейнер уже создан, для его запуска нужно выполнить
команду

.. code-block:: bash
    
    docker start addressokdata

либо воспользоваться вспомогательным скриптом ``start_dvc``:

.. code-block:: bash
    
    cd addressok_docker_compose
    ./start_dvc

Запуск остальных контейнеров
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Все контейнеры сервиса, кроме data-контейнера, запускаются при помощи
**Docker Compose**.

.. _service-run:

Запуск сервиса
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Для запуска сервиса воспользуйтесь командой ``docker-compose up -d``:

.. code-block:: bash
    
    cd addressok_docker_compose
    docker-compose up -d

Первый запуск сервиса
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

При первом запуске сервиса необходимо запустить процесс обновления базы данных
(загрузки данных с сайта ФИАС и их загрузки в БД), т.к. изначально база данных
пуста (см. :ref:`db-update`).

.. _db-update:

Обновление базы данных
-------------------------------------------------------------------------------

Для обновления базы данных запустите контейнер ``addressok`` командой
``docker-compose run`` с указанием параметра ``update-db``, находясь в папке
``addressok_docker_compose``:

.. code-block:: bash
    
    cd addressok_docker_compose
    docker-compose run addressok update-db

.. attention:: При обновлении БД сервис должен быть запущен
    (см. :ref:`service-run`).

При обновлении базы данных запустится скрипт ``/app/check_update.py``.
Скрипт проверит наличие на сайте `ФИАС <http://fias.nalog.ru/>`_ базы с более новой версией и, если
таковая найдена, архив с данными будет скачан, и запустится процесс обновления
БД.

Процесс обновления может занять довольно длительное время, т.к. помимо
скачивания архива и записи данных в базу происходит заполнение вспомогательных
таблиц для быстрого поиска, а также формирование отформатированных названий
адресных объектов.

При этом сервис будет продолжать работать, т.к. данные записываются в новые
таблицы БД. В конце процесса обновления происходит переключение сервиса на новые
таблицы, а старые таблицы удаляются.

Итого
-------------------------------------------------------------------------------

Итого перечень шагов для запуска копии сервиса таков:

* Скачать репозиторий AddressOK
* Выполнить в консоли:

.. code-block:: bash
    
    cd addressok_docker_compose
    ./make_dvc
    docker-compose up -d
    docker-compose run addressok update-db

* После завершения процесса обновления БД сервис доступен на порту 14000!

Можно приступать к подключению сервиса к сайту (см. :ref:`connect-to-site`).
